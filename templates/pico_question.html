{% extends "base.html" %}

{% block title %}NEMRAS - PICO Search{% endblock %}

{% block body_class %}pico-search{% endblock %}


{% block content %}
<div style="background: rgb(130,138,176);
background: linear-gradient(27deg, rgba(130,138,176,1) 51%, rgba(147,150,179,1) 76%); padding: 20px; min-height: 100vh;">
    <div class="container mt-5">
        <h1 class="text-center mb-4">PICO Search</h1>
        <form id="picoForm">
            <div class="mb-3">
                <label for="pico_question" class="form-label">Enter Your PICO Question:</label>
                <textarea class="form-control" id="pico_question" name="pico_question" rows="3" required></textarea>
            </div>
            <div class="text-center">
                <button type="submit" id="submitButton" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <span class="button-text">Submit</span>
                </button>
            </div>
        </form>

        <div id="resultsSection" class="mt-5 d-none">
            <h2>Parsed PICO Components:</h2>
            <ul id="picoComponents" class="list-group mb-4">
            </ul>

            <h2>Search Results:</h2>
            <div id="searchResults" class="row row-cols-1 row-cols-md-2 g-4">
            </div>

            <div class="mt-4">
                <button id="newSearchButton" class="btn btn-primary">New Search</button>
                <button id="helpButton" class="btn btn-secondary">Help with PICO Question</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}






{% block extra_js %}
<script>
document.getElementById('picoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const button = document.getElementById('submitButton');
    const spinner = button.querySelector('.spinner-border');
    const buttonText = button.querySelector('.button-text');

    // Disable the button and show spinner
    button.disabled = true;
    spinner.classList.remove('d-none');
    buttonText.textContent = 'Processing...';

    // Get form data
    const formData = new FormData(this);

    // Submit the form via AJAX
    fetch("{{ url_for('main.pico_question') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Handle the response
        displayResults(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request. Please try again.');
    })
    .finally(() => {
        // Re-enable the button and hide spinner
        button.disabled = false;
        spinner.classList.add('d-none');
        buttonText.textContent = 'Submit';
    });
});

function displayResults(data) {
    const resultsSection = document.getElementById('resultsSection');
    const picoComponents = document.getElementById('picoComponents');
    const searchResults = document.getElementById('searchResults');

    // Display PICO components
    picoComponents.innerHTML = '';
    for (const [component, value] of Object.entries(data.pico)) {
        picoComponents.innerHTML += `<li class="list-group-item"><strong>${component}:</strong> ${value}</li>`;
    }

    // Display search results
    searchResults.innerHTML = '';
    data.results.forEach((result, index) => {
        searchResults.innerHTML += `
            <div class="col">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Paper ${index + 1}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">Abstract</h6>
                        <p class="card-text">${result.abstract.substring(0, 200)}...</p>
                        <h6 class="card-subtitle mb-2 text-muted">Summary</h6>
                        <p class="card-text">${result.summary}</p>
                    </div>
                </div>
            </div>
        `;
    });

    // Show results section
    resultsSection.classList.remove('d-none');
}

document.getElementById('newSearchButton').addEventListener('click', function() {
    document.getElementById('picoForm').reset();
    document.getElementById('resultsSection').classList.add('d-none');
});


</script>
{% endblock %}